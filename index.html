<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Video Player</title>
    
    <meta name="referrer" content="no-referrer">
    <link rel="preconnect" href="https://www.youtube-nocookie.com">
    <link rel="preconnect" href="https://www.google.com">

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
        }

        /* --- Auth Header --- */
        .auth-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444;
        }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #555; display: none; }
        .user-name { font-size: 14px; color: #ccc; }
        .btn-auth {
            background-color: #4285F4; color: white; border: none; padding: 8px 16px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s;
        }
        .btn-auth:hover { background-color: #3367d6; }
        .btn-logout { background-color: #555; }

        /* --- Input & Player --- */
        .input-group { display: flex; gap: 10px; margin-bottom: 5px; }
        input {
            flex: 1; padding: 12px; border-radius: 5px; border: 1px solid #444;
            background: #333; color: white; font-size: 16px;
        }
        button.play-btn {
            padding: 12px 24px; background-color: #007bff; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; white-space: nowrap;
        }
        button.play-btn:hover { background-color: #0056b3; }
        button:disabled { background-color: #555 !important; cursor: not-allowed; }

        /* --- Converter Section --- */
        .converter-box {
            background: #383838; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; border: 1px solid #555;
        }
        .converter-title { color: #f0ad4e; margin: 0 0 10px 0; font-size: 16px; }
        .converter-desc { font-size: 12px; color: #ccc; margin-bottom: 10px; }

        /* --- Result Section --- */
        .result-area {
            display: none; margin-top: 15px; padding: 10px; background: #222; border-radius: 5px; border: 1px solid #4caf50;
        }
        .result-label { font-size: 12px; color: #aaa; margin-bottom: 5px; display: block; }
        .result-input { width: 100%; background: #111; color: #4caf50; border: none; margin-bottom: 0 !important; }

        #player-wrapper {
            width: 100%; position: relative; padding-bottom: 56.25%; height: 0;
            background: #000; border-radius: 8px; overflow: hidden; display: none; margin-bottom: 15px;
        }
        #player-wrapper iframe, #player-wrapper video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
        }
        
        /* --- Video Actions --- */
        .video-actions { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; display: none; }
        .action-btn {
            background: #444; color: white; border: none; padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .action-btn:hover { background: #555; }
        .action-btn.active { background: #ffc107; color: #000; } 

        /* --- Tabs & Lists --- */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; background: none; border: none; padding: 10px; color: #888;
            cursor: pointer; font-size: 15px; border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: white; border-bottom: 2px solid #007bff; font-weight: bold; }

        #list-container { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        .list-item {
            padding: 10px; border-bottom: 1px solid #333; background: #2d2d2d;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:hover { background: #383838; }
        .item-text { cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 15px; flex-grow: 1; color: #eee; font-size: 14px; }
        .icon-btn { cursor: pointer; padding: 4px; color: #888; font-size: 16px; }
        .delete-btn:hover { color: #ff6b6b; }
        .playlist-folder { display: flex; align-items: center; gap: 10px; font-weight: bold; color: #8ab4f8; }
        .back-btn { width: 100%; text-align: left; background: #333; border: none; color: white; padding: 8px; cursor: pointer; margin-bottom: 5px; border-radius: 4px; }

        /* Fallback */
        #fallback-container { display: none; margin-bottom: 20px; text-align: center; background: #333; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .popout-btn { background: #d9534f; color: white; padding: 12px 24px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; margin-top: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .sniffer-btn { background: #666; color: white; padding: 4px 8px; border-radius: 4px; text-decoration: none; font-size: 12px; border: 1px solid #888; display: inline-block; cursor: grab; }
        
        .status-msg { margin: 10px 0; padding: 10px; border-radius: 5px; display: none; font-size: 14px; word-break: break-all; }
        .info { background: #17a2b8; } .error { background: #d9534f; } .success { background: #28a745; }
        .empty-state { padding: 20px; text-align: center; color: #777; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <div class="auth-header">
        <div class="user-profile">
            <img id="userAvatar" class="user-avatar" src="" alt="">
            <span id="userName" class="user-name">Not signed in</span>
        </div>
        <button id="authBtn" class="btn-auth" onclick="handleAuth()">Sign in with Google</button>
    </div>

    <!-- CONVERTER SECTION -->
    <div class="converter-box">
        <h3 class="converter-title">üîó Smart Link Converter</h3>
        <p class="converter-desc">Paste a regular video link. We will instantly calculate the best playable link for you.</p>
        
        <div class="input-group">
            <input type="text" id="convertInput" placeholder="https://xhamster.com/videos/...">
            <button id="convertBtn" class="play-btn" style="background: #f0ad4e;" onclick="smartConvert()">‚ú® Convert</button>
        </div>
        
        <!-- Result Area -->
        <div id="conversionResult" class="result-area">
            <span class="result-label">‚úÖ Clean Link Generated! Copy below:</span>
            <div class="input-group" style="margin-bottom:0;">
                <input type="text" id="extractedUrl" class="result-input" readonly>
                <button class="play-btn" style="background: #4caf50;" onclick="copyToClipboard()">üìã Copy</button>
            </div>
            <p style="font-size:11px; color:#aaa; margin:5px 0 0 0;">* Paste this into the player below. If it fails, use the Pop-out button.</p>
        </div>

        <!-- Manual Fallback -->
        <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #555;">
            <p style="font-size:11px; color:#777; margin:0;">
                Advanced: For raw .m3u8 streams, drag this to your bookmarks: 
                <a class="sniffer-btn" href="javascript:(function(){var m=performance.getEntriesByType('resource').map(e=>e.name).filter(n=>n.includes('.m3u8'));if(m.length){prompt('Stream URL found! Copy this:',m[m.length-1])}else{alert('No stream found yet. 1. Play the video. 2. Click this bookmark again.')}})">üïµÔ∏è Sniffer</a>
            </p>
        </div>
    </div>

    <!-- MAIN PLAYER -->
    <div class="input-group">
        <input type="text" id="videoLink" placeholder="Paste link here to play...">
        <button class="play-btn" onclick="playVideo()">Play</button>
    </div>
    
    <div id="statusMsg" class="status-msg"></div>

    <div id="player-wrapper"></div>
    
    <div id="videoActions" class="video-actions">
        <button id="btnFav" class="action-btn" onclick="toggleFavorite()"><span>‚≠ê</span> Favorite</button>
        <button class="action-btn" onclick="addToPlaylist()"><span>üìÇ</span> Add to Playlist</button>
    </div>

    <div id="fallback-container">
        <!-- Injected by JS -->
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('history')" id="tab-history">History</button>
        <button class="tab-btn" onclick="switchTab('favorites')" id="tab-favorites">Favorites</button>
        <button class="tab-btn" onclick="switchTab('playlists')" id="tab-playlists">Playlists</button>
    </div>

    <div id="list-view-area">
        <ul id="list-container">
            <li class="empty-state">Sign in to view your data.</li>
        </ul>
    </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAHAkFmBFw4hPcYq5lJbJoLS4jlcEDcTbk",
        authDomain: "cloud-player-8c1b9.firebaseapp.com",
        projectId: "cloud-player-8c1b9",
        storageBucket: "cloud-player-8c1b9.firebasestorage.app",
        messagingSenderId: "168933807242",
        appId: "1:168933807242:web:2cd70df286176208d94973",
        measurementId: "G-305QV5NYMK"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State
    let currentUser = null;
    let userData = { history: [], favorites: [], playlists: {} };
    let currentTab = 'history'; 
    let activePlaylist = null; 
    let currentVideoUrl = ""; 
    let currentEmbedUrl = ""; 
    let unsubscribe = null;
    let hls = null; 

    // --- 2. AUTHENTICATION ---
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        updateAuthUI(user);
        if (user) subscribeToData(user.uid);
        else {
            if (unsubscribe) unsubscribe();
            userData = { history: [], favorites: [], playlists: {} };
            renderList();
        }
    });

    function handleAuth() {
        if (currentUser) auth.signOut();
        else auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => showStatus(e.message, 'error'));
    }

    function updateAuthUI(user) {
        const btn = document.getElementById('authBtn');
        const name = document.getElementById('userName');
        const avatar = document.getElementById('userAvatar');
        if (user) {
            btn.textContent = 'Sign Out'; btn.classList.add('btn-logout');
            name.textContent = user.displayName; avatar.src = user.photoURL; avatar.style.display = 'block';
        } else {
            btn.textContent = 'Sign in'; btn.classList.remove('btn-logout');
            name.textContent = 'Not signed in'; avatar.style.display = 'none';
        }
    }

    // --- 3. DATA LOGIC ---
    function subscribeToData(uid) {
        const docRef = db.collection('users').doc(uid);
        unsubscribe = docRef.onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                userData.history = data.history || [];
                userData.favorites = data.favorites || [];
                userData.playlists = data.playlists || {};
            }
            renderList();
            updateFavBtnState();
        });
    }

    // --- 4. TABS & RENDERING ---
    function switchTab(tab) {
        currentTab = tab;
        activePlaylist = null; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        renderList();
    }

    function renderList() {
        const list = document.getElementById('list-container');
        list.innerHTML = '';
        if (!currentUser) { list.innerHTML = '<li class="empty-state">Sign in to sync your data.</li>'; return; }

        if (currentTab === 'history') {
            if (userData.history.length === 0) list.innerHTML = '<li class="empty-state">No history yet.</li>';
            else userData.history.forEach(url => list.appendChild(createListItem(url, 'history')));
        }
        else if (currentTab === 'favorites') {
            if (userData.favorites.length === 0) list.innerHTML = '<li class="empty-state">No favorites yet.</li>';
            else userData.favorites.forEach(url => list.appendChild(createListItem(url, 'favorites')));
        }
        else if (currentTab === 'playlists') {
            if (activePlaylist) {
                const videos = userData.playlists[activePlaylist] || [];
                const backBtn = document.createElement('button');
                backBtn.className = 'back-btn';
                backBtn.innerHTML = `‚¨Ö Back to Playlists`;
                backBtn.onclick = () => { activePlaylist = null; renderList(); };
                list.appendChild(backBtn);
                
                const title = document.createElement('h3');
                title.style.margin = '10px 0'; title.style.color = '#8ab4f8';
                title.textContent = `üìÇ ${activePlaylist}`;
                list.appendChild(title);

                if(videos.length === 0) {
                    const li = document.createElement('li'); li.className = 'empty-state'; li.textContent = 'Empty playlist.'; list.appendChild(li);
                } else {
                    videos.forEach(url => list.appendChild(createListItem(url, 'playlist', activePlaylist)));
                }
            } else {
                const names = Object.keys(userData.playlists);
                if (names.length === 0) list.innerHTML = '<li class="empty-state">No playlists.</li>';
                else names.forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <div class="playlist-folder" onclick="openPlaylist('${name}')" style="cursor:pointer; flex:1;">
                            <span>üìÇ</span> ${name} <span class="item-meta">(${userData.playlists[name].length})</span>
                        </div>
                        <span class="icon-btn delete-btn" onclick="deletePlaylist('${name}')">‚úï</span>
                    `;
                    list.appendChild(li);
                });
            }
        }
    }

    function createListItem(url, type, playlistName = null) {
        const li = document.createElement('li');
        li.className = 'list-item';
        li.innerHTML = `
            <span class="item-text" onclick="playSavedUrl('${url}')">${url}</span>
            <span class="icon-btn delete-btn" title="Remove">‚úï</span>
        `;
        li.querySelector('.delete-btn').onclick = (e) => {
            e.stopPropagation();
            if (type === 'history') removeFromHistory(url);
            if (type === 'favorites') toggleFavorite(url); 
            if (type === 'playlist') removeFromPlaylist(url, playlistName);
        };
        return li;
    }

    function openPlaylist(name) { activePlaylist = name; renderList(); }

    // --- 5. ACTIONS ---
    function toggleFavorite(targetUrl = null) {
        if (!currentUser) return alert("Please sign in first.");
        const url = targetUrl || currentVideoUrl;
        if (!url) return;
        const docRef = db.collection('users').doc(currentUser.uid);
        if (userData.favorites.includes(url)) docRef.update({ favorites: firebase.firestore.FieldValue.arrayRemove(url) });
        else docRef.update({ favorites: firebase.firestore.FieldValue.arrayUnion(url) });
    }

    function addToPlaylist() {
        if (!currentUser) return alert("Please sign in first.");
        if (!currentVideoUrl) return alert("Play a video first.");
        const playlistName = prompt("Enter Playlist Name:", "My Playlist");
        if (!playlistName) return;
        const safeName = playlistName.trim().replace('.', '');
        if (!safeName) return;
        const docRef = db.collection('users').doc(currentUser.uid);
        let updateData = {};
        updateData[`playlists.${safeName}`] = firebase.firestore.FieldValue.arrayUnion(currentVideoUrl);
        docRef.update(updateData).then(() => {
            showStatus(`Added to "${safeName}"`, 'info');
            if(currentTab !== 'playlists') switchTab('playlists');
        }).catch(e => docRef.set(updateData, { merge: true }));
    }

    function removeFromHistory(url) {
        db.collection('users').doc(currentUser.uid).update({ history: firebase.firestore.FieldValue.arrayRemove(url) });
    }
    function removeFromPlaylist(url, pName) {
        let u = {}; u[`playlists.${pName}`] = firebase.firestore.FieldValue.arrayRemove(url);
        db.collection('users').doc(currentUser.uid).update(u);
    }
    function deletePlaylist(name) {
        if(!confirm(`Delete playlist "${name}"?`)) return;
        let u = {}; u[`playlists.${name}`] = firebase.firestore.FieldValue.delete();
        db.collection('users').doc(currentUser.uid).update(u);
    }

    function updateFavBtnState() {
        const btn = document.getElementById('btnFav');
        const container = document.getElementById('videoActions');
        if (!currentVideoUrl) { container.style.display = 'none'; return; }
        container.style.display = 'flex';
        if (userData.favorites.includes(currentVideoUrl)) {
            btn.classList.add('active'); btn.innerHTML = '<span>‚≠ê</span> Favorited';
        } else {
            btn.classList.remove('active'); btn.innerHTML = '<span>‚òÜ</span> Favorite';
        }
    }

    // --- 6. SMART CONVERTER (Regex Method - No Scanning) ---
    function smartConvert() {
        const rawInput = document.getElementById('convertInput').value.trim();
        const resBox = document.getElementById('conversionResult');
        const outInput = document.getElementById('extractedUrl');
        
        if (!rawInput) return;

        // Try to generate an Embed URL using the smart logic
        const smartLink = getSmartEmbedURL(rawInput);

        if (smartLink) {
            outInput.value = smartLink;
            resBox.style.display = 'block';
            showStatus("Link Converted! Use this in the player.", "success");
        } else {
            showStatus("Could not auto-convert. Please use the Sniffer bookmarklet.", "error");
            resBox.style.display = 'none';
        }
    }

    function copyToClipboard() {
        const copyText = document.getElementById("extractedUrl");
        copyText.select();
        document.execCommand("copy");
        showStatus("Copied! Paste in player below.", "success");
    }

    // --- 7. PLAYER LOGIC ---
    function playVideo() {
        const url = document.getElementById('videoLink').value.trim();
        if (url) { loadPlayer(url); saveHistory(url); }
    }

    function saveHistory(url) {
        if (currentUser) {
             const docRef = db.collection('users').doc(currentUser.uid);
             docRef.set({ history: firebase.firestore.FieldValue.arrayUnion(url) }, { merge: true });
        }
    }

    function playSavedUrl(url) {
        document.getElementById('videoLink').value = url;
        playVideo();
    }

    function loadPlayer(url) {
        currentVideoUrl = url;
        if(hls) { hls.destroy(); hls = null; } 

        const wrapper = document.getElementById('player-wrapper');
        const fallback = document.getElementById('fallback-container');
        const statusMsg = document.getElementById('statusMsg');
        
        wrapper.innerHTML = ''; wrapper.style.display = 'none';
        fallback.style.display = 'none'; statusMsg.style.display = 'none';

        // 1. Direct HLS
        if(url.includes('.m3u8')) {
            wrapper.style.display = 'block';
            if(Hls.isSupported()) {
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.style.width = '100%'; video.style.height = '100%';
                wrapper.appendChild(video);
                
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, (e, data) => {
                    if(data.fatal) showStatus("Stream Error: " + data.type, 'error');
                });
                showStatus("Playing Stream...", "info");
            } else if (wrapper.canPlayType('application/vnd.apple.mpegurl')) {
                wrapper.innerHTML = `<video src="${url}" controls autoplay style="width:100%;height:100%"></video>`;
            }
            updateFavBtnState();
            return;
        }

        // 2. YouTube
        const ytId = getYouTubeID(url);
        if (ytId) {
            wrapper.style.display = 'block';
            wrapper.innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${ytId}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
            updateFavBtnState();
            return;
        }
        
        // 3. Direct File
        if (url.match(/\.(mp4|webm|ogg)($|\?)/i)) {
            wrapper.style.display = 'block';
            wrapper.innerHTML = `<video controls autoplay><source src="${url}" type="video/mp4"></video>`;
            updateFavBtnState();
            return;
        }

        // 4. Fallback Embed (Smart URL handled here)
        // If user pasted a raw link (not converted), we convert it on the fly too
        const embedUrl = getSmartEmbedURL(url) || url;
        currentEmbedUrl = embedUrl; 
        
        wrapper.style.display = 'block';
        
        const isStrict = url.includes('xhamster') || url.includes('pornhub');
        if(isStrict) {
             fallback.innerHTML = `
                <p style="margin:0 0 8px 0; color:#ffc107; font-size:14px;">
                    <strong>‚ö†Ô∏è Note:</strong> If the screen is black, this site requires the Pop-out player.
                </p>
                <button class="popout-btn" onclick="openPopupPlayer()">üöÄ Launch Pop-out Player</button>
            `;
            fallback.style.display = 'block';
        } else {
             fallback.innerHTML = `
                <p style="margin:0 0 8px 0; color:#ddd; font-size:14px;">
                    <strong>Video Blocked?</strong> Use the secure Pop-out player.
                </p>
                <button class="popout-btn" onclick="openPopupPlayer()">üöÄ Launch Pop-out Player</button>
            `;
            fallback.style.display = 'block';
        }

        wrapper.innerHTML = `
            <iframe 
                src="${embedUrl}" 
                frameborder="0" 
                loading="eager"
                allowfullscreen 
                referrerpolicy="no-referrer">
            </iframe>
        `;
        updateFavBtnState();
    }

    function openPopupPlayer() {
        const urlToPlay = currentEmbedUrl || currentVideoUrl;
        if(urlToPlay) window.open(urlToPlay, 'Popout', 'width=854,height=480,scrollbars=yes');
    }

    function getSmartEmbedURL(url) {
        try {
            const u = new URL(url);
            const d = u.hostname.toLowerCase();
            const p = u.pathname.replace(/\/$/, '');
            if (d.includes('pornhub')) {
                const k = url.match(/viewkey=([^&]+)/);
                return k ? `https://www.pornhub.com/embed/${k[1]}` : null;
            }
            if (d.includes('xhamster')) {
                let m = p.match(/(xh[a-zA-Z0-9]+)/) || p.match(/(\d+)$/);
                return m ? `https://xhamster.com/embed/${m[1]}` : null;
            }
            if (d.includes('xvideos')) {
                let m = url.match(/video(\d+)/);
                return m ? `https://www.xvideos.com/embedframe/${m[1]}` : null;
            }
            if (d.includes('spankbang')) {
                let m = url.match(/\/([\w\d]+)\/video/);
                return m ? `https://spankbang.com/${m[1]}/embed/` : null;
            }
        } catch(e) {}
        return null;
    }

    function getYouTubeID(url) {
        const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
        return (m && m[2].length === 11) ? m[2] : null;
    }

    function showStatus(msg, type) {
        const el = document.getElementById('statusMsg');
        el.innerText = msg; el.className = 'status-msg ' + type; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 6000);
    }
</script>
</body>
</html>
